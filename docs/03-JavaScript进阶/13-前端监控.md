# 前端错误监控

## why

前端不管怎么变化，始终是直接面向用户

- 增强用户体验；
- 远程定位问题；
- 未雨绸缪，及早发现问题；
- 无法复现问题，尤其是移动端，机型，系统都是问题；
- 完善的前端方案，前端监控系统；

对于 `JS` 而言，异常的出现不会直接导致 `JS` 引擎崩溃，最多只会使当前执行的任务终止。

## 异常

- JS 语法错误、代码异常
- AJAX 请求异常
- 静态资源加载异常
- Promise 异常
- Iframe 异常
- 跨域 Script error
- 崩溃和卡顿

发生时间大致判断

- DNS 查询耗时 ：domainLookupEnd - domainLookupStart
- TCP 链接耗时 ：connectEnd - connectStart
- request 请求耗时 ：responseEnd - responseStart
- 解析 dom 树耗时 ： domComplete - domInteractive
- 白屏时间 ：responseStart - navigationStart
- domready 时间 ：domContentLoadedEventEnd - navigationStart
- onload 时间 ：loadEventEnd – navigationStart

- 在 head 标签解析后，渲染 body 标签前加入 script 标签进行打点，一般将这个时间视为白屏时间
- 捕获 DOMContentLoaded 事件来记录 dom 元素加载完毕的时间
- 在首屏页面的所有图片加载完后进行记录，保存首屏时间
- 捕获 load 事件记录页面加载完成的时间

## 错误搜集

### window.onerror

`window.onerror` 可以捕捉运行时错误，可以拿到出错的信息，堆栈，出错的文件、行号、列号

要注意以下几点：

- 要把 `window.onerror` 这个代码块分离出去，并且比其他脚本先执行（注意这个前提！）即可捕捉到语法错误。

- 由于网络请求异常事件不会冒泡，需要在捕获阶段进行处理

- 不能捕获 `promise` 的错误信息

- 跨域资源需要专门处理，需要在 `script` 标签加上 `crossorigin` 属性，服务器设置 `Access-Control-Allow-Origin`

- `window.onerror` 函数只有在返回 `true` 的时候，异常才不会向上抛出，否则即使是知道异常的发生控制台还是会显示 `Uncaught Error: xxxxx。`

```js
window.onerror = function(message, source, lineno, colno, error) {
  console.log("捕获到异常：", { message, source, lineno, colno, error });
};
setTimeout(() => {
  Jartto;
});
```

> <http://jartto.wang/2018/11/20/js-exception-handling/index.html>
